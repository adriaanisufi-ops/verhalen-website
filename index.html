<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verhalen</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#6d28d9; --accent2:#7c3aed; --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:36px auto;padding:0 16px 60px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px 16px;
      background:rgba(255,255,255,.65);border:1px solid var(--border);border-radius:var(--radius);backdrop-filter:blur(8px)}
    .brand h1{margin:0;font-size:22px;letter-spacing:-.02em}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:14px;
      border:1px solid var(--border);background:var(--card);color:var(--text);text-decoration:none;cursor:pointer}
    .btn-primary{border-color:rgba(109,40,217,.25);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
    .status{margin:14px 4px 0;color:var(--muted);font-size:14px}
    .error{margin:10px 4px 0;color:var(--danger);white-space:pre-wrap;font-size:14px}

    .story{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .story-head{padding:18px 18px 10px}
    .story h2{margin:0;font-size:18px;letter-spacing:-.02em}
    .meta{margin-top:6px;color:var(--muted);font-size:13px}
    .story-body{padding:0 18px 16px;line-height:1.65;white-space:pre-wrap}

    .story-actions{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 18px;
      border-top:1px solid var(--border);background:#fafafa}
    .small{font-size:13px;color:var(--muted)}

    .comments{display:none;padding:14px 18px 18px;border-top:1px solid var(--border);background:#fff}
    .comments.open{display:block}
    .comment{border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:10px;background:#fff}
    .comment p{margin:8px 0 0;white-space:pre-wrap;line-height:1.5}

    .form{margin-top:12px;display:grid;gap:10px}
    input,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);font:inherit;background:#fff}
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    .hint{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <h1>Verhalen</h1>
        <p>Lees, deel en reageer — met respect.</p>
      </div>
      <a class="btn btn-primary" href="deel.html">Deel jouw verhaal</a>
    </div>

    <div id="status" class="status">Verhalen laden...</div>
    <div id="error" class="error"></div>
    <div id="stories"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    function escapeHtml(str){return (str??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}
    function fmtDate(ts){ try { return new Date(ts).toLocaleString("nl-NL"); } catch { return ""; } }

    async function loadStories(){
      const statusEl=document.getElementById("status");
      const errorEl=document.getElementById("error");
      const wrap=document.getElementById("stories");
      errorEl.textContent=""; wrap.innerHTML="";

      try{
        if(!window.supabaseClient) throw new Error("Supabase client niet geladen. Controleer supabase.js");

        const { data, error } = await window.supabaseClient
          .from("stories")
          .select("id,title,author_name,created_at,content")
          .order("created_at",{ascending:false})
          .limit(50);

        if(error) throw error;

        if(!data || data.length===0){
          statusEl.textContent="Nog geen verhalen. Wees de eerste!";
          return;
        }

        statusEl.textContent="";

        data.forEach((s)=>{
          const el=document.createElement("section");
          el.className="story";
          el.innerHTML=`
            <div class="story-head">
              <h2>${escapeHtml(s.title)}</h2>
              <div class="meta">${s.author_name ? "Door "+escapeHtml(s.author_name)+" · " : ""}${fmtDate(s.created_at)}</div>
            </div>
            <div class="story-body">${escapeHtml(s.content)}</div>

            <div class="story-actions">
              <button class="btn" data-action="toggle-comments" data-story="${s.id}">Reacties bekijken</button>
              <span class="small" id="count-${s.id}"></span>
            </div>

            <div class="comments" id="comments-${s.id}">
              <div class="hint" id="cstatus-${s.id}">Reacties laden...</div>
              <div id="clist-${s.id}"></div>

              <form class="form" data-action="comment-form" data-story="${s.id}">
                <input name="author" placeholder="Jouw naam (optioneel)" />
                <textarea name="content" placeholder="Schrijf een reactie..." required></textarea>
                <div class="row">
                  <span class="hint" id="cmsg-${s.id}"></span>
                  <button class="btn btn-primary" type="submit">Plaats reactie</button>
                </div>
              </form>
            </div>
          `;
          wrap.appendChild(el);
        });

        wrap.addEventListener("click", async (e)=>{
          const btn=e.target.closest("[data-action='toggle-comments']");
          if(!btn) return;
          const storyId=btn.getAttribute("data-story");
          const panel=document.getElementById(`comments-${storyId}`);
          const isOpen=panel.classList.toggle("open");
          btn.textContent=isOpen ? "Reacties verbergen" : "Reacties bekijken";
          if(isOpen) await loadComments(storyId);
        });

        wrap.addEventListener("submit", async (e)=>{
          const form=e.target.closest("[data-action='comment-form']");
          if(!form) return;
          e.preventDefault();
          const storyId=form.getAttribute("data-story");
          await submitComment(form, storyId);
        });

        data.forEach(s => loadCommentCount(s.id));

      }catch(err){
        console.error(err);
        statusEl.textContent="";
        errorEl.textContent="Fout:\n"+(err?.message||String(err));
      }
    }

    async function loadCommentCount(storyId){
      try{
        const { count, error } = await window.supabaseClient
          .from("comments")
          .select("id", { count: "exact", head: true })
          .eq("story_id", storyId);
        if(error) throw error;
        const el=document.getElementById(`count-${storyId}`);
        if(el) el.textContent=`${count ?? 0} reactie(s)`;
      }catch{}
    }

    async function loadComments(storyId){
      const statusEl=document.getElementById(`cstatus-${storyId}`);
      const listEl=document.getElementById(`clist-${storyId}`);
      statusEl.textContent="Reacties laden..."; listEl.innerHTML="";

      try{
        const { data, error } = await window.supabaseClient
          .from("comments")
          .select("id,author_name,content,created_at")
          .eq("story_id", storyId)
          .order("created_at",{ascending:true});
        if(error) throw error;

        if(!data || data.length===0){
          statusEl.textContent="Nog geen reacties. Wees de eerste!";
          return;
        }

        statusEl.textContent="";
        data.forEach(c=>{
          const div=document.createElement("div");
          div.className="comment";
          div.innerHTML=`
            <div class="meta">${c.author_name ? "Door "+escapeHtml(c.author_name)+" · " : ""}${fmtDate(c.created_at)}</div>
            <p>${escapeHtml(c.content)}</p>
          `;
          listEl.appendChild(div);
        });

      }catch(err){
        console.error(err);
        statusEl.textContent="Fout bij laden reacties: "+(err?.message||String(err));
      }
    }

    async function submitComment(form, storyId){
      const msgEl=document.getElementById(`cmsg-${storyId}`);
      msgEl.textContent="Plaatsen...";
      const author=(form.elements.author.value||"").trim();
      const content=(form.elements.content.value||"").trim();

      try{
        const { error } = await window.supabaseClient
          .from("comments")
          .insert({ story_id: storyId, author_name: author||null, content });
        if(error) throw error;

        form.reset();
        msgEl.textContent="✅ Geplaatst!";
        setTimeout(()=>msgEl.textContent="",1200);

        await loadComments(storyId);
        await loadCommentCount(storyId);

      }catch(err){
        console.error(err);
        msgEl.textContent="❌ "+(err?.message||String(err));
      }
    }

    loadStories();
  </script>
</body>
</html>
