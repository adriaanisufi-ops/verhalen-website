<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verhalen</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(255,255,255,.06);
      --text:#eef2ff;
      --muted: rgba(238,242,255,.70);
      --border: rgba(255,255,255,.12);
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --danger:#fb7185;
      --radius:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(139,92,246,.30), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(34,211,238,.22), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(251,113,133,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .container{max-width:980px;margin:0 auto;padding:22px 16px 60px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand-wrap{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand p{margin:3px 0 0;color:var(--muted);font-size:13px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text); text-decoration:none;
      font-weight:600; font-size:14px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn-primary{
      border:1px solid rgba(139,92,246,.35);
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.75));
      box-shadow: 0 14px 40px rgba(139,92,246,.20);
    }

    .status{margin:14px 6px 0;color:var(--muted);font-size:14px}
    .error{margin:10px 6px 0;color:var(--danger);font-weight:700;white-space:pre-wrap}
    .grid{margin-top:16px;display:grid;gap:14px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center;color:var(--muted);font-size:13px;margin-top:6px}
    .title{margin:0;font-size:16px}
    .content{margin:10px 0 0;white-space:pre-wrap;line-height:1.65}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{
      font-size:12px;color:rgba(238,242,255,.85);
      padding:5px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .mini{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand-wrap">
        <div class="logo" title="Yin & Yang">
          <svg viewBox="0 0 100 100" width="26" height="26" aria-hidden="true">
            <circle cx="50" cy="50" r="48" fill="white"/>
            <path d="M50 2 a48 48 0 1 0 0 96
                     a24 24 0 1 1 0-48
                     a24 24 0 1 0 0-48" fill="black"/>
            <circle cx="50" cy="26" r="6" fill="white"/>
            <circle cx="50" cy="74" r="6" fill="black"/>
          </svg>
        </div>
        <div class="brand">
          <h1>Verhalen</h1>
          <p>Lees, deel, like en reageer ‚Äî met respect.</p>
        </div>
      </div>

      <div class="actions">
        <a class="btn" id="authBtn" href="./login.html">Inloggen</a>
        <a class="btn btn-primary" href="./deel.html">Deel jouw verhaal</a>
      </div>
    </div>

    <div id="status" class="status">Verhalen laden‚Ä¶</div>
    <div id="error" class="error"></div>
    <div id="stories" class="grid"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    const statusEl = document.getElementById("status");
    const errorEl  = document.getElementById("error");
    const wrapEl   = document.getElementById("stories");

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function formatDate(iso){
      try{
        return new Date(iso).toLocaleString("nl-NL", { dateStyle:"medium", timeStyle:"short" });
      }catch(e){ return ""; }
    }

    async function updateAuthButton() {
      const authBtn = document.getElementById("authBtn");
      if (!authBtn) return;

      if (!window.supabaseClient) {
        // als client niet geladen is, laat knop gewoon naar login gaan
        authBtn.textContent = "Inloggen";
        authBtn.href = "./login.html";
        return;
      }

      const { data: { user }, error } = await window.supabaseClient.auth.getUser();
      if (error) {
        authBtn.textContent = "Inloggen";
        authBtn.href = "./login.html";
        return;
      }

      if (user) {
        authBtn.textContent = "Profiel";
        authBtn.href = "./profile.html";
      } else {
        authBtn.textContent = "Inloggen";
        authBtn.href = "./login.html";
      }
    }

    async function safeCount(table, storyId){
      try{
        const { count, error } = await window.supabaseClient
          .from(table)
          .select("*", { count:"exact", head:true })
          .eq("story_id", storyId);

        if (error) return null;
        return count ?? 0;
      } catch {
        return null;
      }
    }

    async function loadStories(){
      errorEl.textContent = "";
      statusEl.textContent = "Verhalen laden‚Ä¶";

      try{
        if (!window.supabaseClient) {
          throw new Error("Supabase client niet geladen. Controleer supabase.js en of de URL/key kloppen.");
        }

        // Debug: laat zien of je ingelogd bent
        const { data: uData } = await window.supabaseClient.auth.getUser();
        const userEmail = uData?.user?.email || "(niet ingelogd)";

        const { data, error } = await window.supabaseClient
          .from("stories")
          .select("id,title,content,author_name,created_at,category,tags")
          .order("created_at", { ascending:false })
          .limit(50);

        if (error) {
          throw new Error(
            "Stories query faalde.\n" +
            "User: " + userEmail + "\n" +
            "Error: " + error.message +
            (error.details ? ("\nDetails: " + error.details) : "") +
            (error.hint ? ("\nHint: " + error.hint) : "")
          );
        }

        if (!data || data.length === 0){
          wrapEl.innerHTML = "";
          statusEl.textContent = "Nog geen verhalen. Klik op ‚ÄòDeel jouw verhaal‚Äô om de eerste te plaatsen.";
          return;
        }

        statusEl.textContent = "";
        wrapEl.innerHTML = "";

        for (const s of data){
          const tags = Array.isArray(s.tags) ? s.tags : [];
          const tagsHtml = tags.length
            ? `<div class="tags">${tags.map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}</div>`
            : "";

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h2 class="title">${escapeHtml(s.title || "Zonder titel")}</h2>
            <div class="meta">
              <span>Door <b>${escapeHtml(s.author_name || "Anoniem")}</b></span>
              <span>‚Ä¢</span>
              <span>${formatDate(s.created_at)}</span>
              <span>‚Ä¢</span>
              <span>Categorie: <b>${escapeHtml(s.category || "Algemeen")}</b></span>
            </div>

            <div class="content">${escapeHtml(s.content || "")}</div>
            ${tagsHtml}

            <div class="divider"></div>
            <div class="mini" id="mini-${s.id}">
              <span>‚ù§Ô∏è Likes: ‚Ä¶</span>
              <span>üí¨ Reacties: ‚Ä¶</span>
            </div>
          `;

          wrapEl.appendChild(card);

          // tel async, blokkeer de page niet
          (async () => {
            const likes = await safeCount("likes", s.id);
            const comments = await safeCount("comments", s.id);
            const mini = document.getElementById(`mini-${s.id}`);
            if (mini){
              mini.innerHTML = `
                <span>‚ù§Ô∏è Likes: ${likes ?? "?"}</span>
                <span>üí¨ Reacties: ${comments ?? "?"}</span>
              `;
            }
          })();
        }

      } catch(err) {
        statusEl.textContent = "";
        errorEl.textContent = "‚ùå " + (err?.message || String(err));
      }
    }

    // init
    updateAuthButton();
    loadStories();

    // auth state change -> update knop + reload stories
    if (window.supabaseClient) {
      window.supabaseClient.auth.onAuthStateChange(() => {
        updateAuthButton();
        loadStories();
      });
    }

    // back-cache fix
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) {
        location.reload();
        return;
      }
      updateAuthButton();
      loadStories();
    });
  </script>
</body>
</html>
