<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verhalen</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
 
/* als je tags/badges ook te transparant zijn */
.tag,
.badge{
  background: rgba(255,255,255,.10) !important;
}
    /* Mooie fade onderaan (voorkomt rare overlap/afsnij-look) */
/* Mooie fade onderaan (maakt onderkant donkerder zodat gradient niet 'overlapt') */
body{
  background:
    radial-gradient(1200px 600px at 15% 10%, rgba(139,92,246,.18), transparent 55%),
    radial-gradient(900px 500px at 85% 20%, rgba(34,211,238,.22), transparent 55%),
    radial-gradient(900px 500px at 50% 90%, rgba(251,113,133,.10), transparent 60%),
    linear-gradient(
      to bottom,
      #0b1020 0%,
      #0b1020 75%,
      #080b18 100%
    );
}

/* Zorg dat je content boven die overlay staat */
.container{
  position: relative;
  z-index: 1;
  padding-bottom: 180px; /* ruimte zodat laatste kaart niet 'in' de fade hangt */
}

/* Extra ruimte zodat content niet tegen de onderkant plakt */
.container{
  padding-bottom: 120px !important;
}
    .panda-side{
  display:flex;
  justify-content:center;
  margin-bottom:14px;
  opacity:.9;
}

.panda-side img{
  width:120px;          /* groter */
  height:auto;
  filter: drop-shadow(0 10px 26px rgba(0,0,0,.55));
}
    :root{
      --bg:#0b1020;
      --bg2:#0f1732;
     --card: rgba(15,23,50,.55);
      --text:#eef2ff;
      --muted: rgba(238,242,255,.70);
      --border: rgba(255,255,255,.12);
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --danger:#fb7185;
      --ok:#34d399;
      --radius:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{

      /* Zachte donker-fade onderaan (maakt de onderkant overal gelijk) */
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events:none;
  background: linear-gradient(
    to bottom,
    rgba(11,16,32,0) 55%,
    rgba(11,16,32,.65) 82%,
    rgba(11,16,32,1) 100%
  );
  z-index: 0;
}

/* Zorg dat je content boven de overlay blijft */
.container{
  position: relative;
  z-index: 1;
}
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
background:
  radial-gradient(1200px 600px at 15% 10%, rgba(139,92,246,.30), transparent 55%),
  radial-gradient(900px 500px at 85% 20%, rgba(34,211,238,.22), transparent 55%),
  radial-gradient(900px 500px at 50% 90%, rgba(251,113,133,.10), transparent 60%),
  radial-gradient(1200px 600px at 50% 95%, rgba(11,16,32,.95), transparent 65%),
  var(--bg);
      min-height:100vh;
    }

    .container{max-width:1100px;margin:0 auto;padding:22px 16px 60px}

    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      border-radius:22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand-wrap{display:flex;align-items:center;gap:12px;min-width:0}
.logo{
  width:44px;
  height:44px;
  border-radius:999px;
  overflow:hidden;

  display:flex;
  align-items:center;
  justify-content:center;

  background:#fff;
  border: 1px solid rgba(255,255,255,.25);
}
    /* Yin-Yang draai animatie */
.yy{
  animation: spin 10s linear infinite;
  transform-origin: 50% 50%;
}

@keyframes spin{
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
    .brand{min-width:0}
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand p{
      margin:3px 0 0;color:var(--muted);font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text); text-decoration:none;
      font-weight:700; font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-primary{
      border:1px solid rgba(139,92,246,.35);
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.75));
      box-shadow: 0 14px 40px rgba(139,92,246,.20);
    }
    .btn-danger{
      border-color: rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
      color: #ffd7de;
    }

    .status{margin:14px 6px 0;color:var(--muted);font-size:14px}
    .error{margin:10px 6px 0;color:var(--danger);font-weight:800;white-space:pre-wrap}
    .ok{margin:10px 6px 0;color:var(--ok);font-weight:800;white-space:pre-wrap}

    /* ====== Layout met sidebar ====== */
    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:14px;
      align-items:start;
    }

    .sidebar{
      position: sticky;
      top: 18px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }

    .sb-title{
      margin: 0 0 10px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
    }

    .input{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    .input::placeholder{ color: rgba(238,242,255,.55); }

    .sb-group{ margin-top: 12px; display:flex; flex-direction:column; gap:8px; }
    .sb-small{ font-weight:700; color: rgba(238,242,255,.65); font-size:12px; }

    .sb-chip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-weight:800;
      font-size: 13px;
    }
    .sb-chip:hover{ background: rgba(255,255,255,.07); }
    .sb-chip.active{
      border-color: rgba(139,92,246,.45);
      box-shadow: 0 0 0 2px rgba(139,92,246,.12);
    }

    /* ====== Cards ====== */
    .grid{display:grid;gap:14px}
    .card{
      background:var(--card);
      will-change: transform;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow: 0 26px 70px rgba(0,0,0,.45);
    }
    .card:active{ transform: translateY(-2px) scale(0.99); }

    .meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center;color:var(--muted);font-size:13px;margin-top:6px}
    .meta2{display:flex;gap:12px;align-items:center}

    .avatar{
      width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.75));
      border:1px solid rgba(255,255,255,.16);
      font-weight:900;
      color:#0b1020;
      flex:0 0 auto;
    }

    .title{margin:6px 0 0;font-size:16px}
    .content{margin:10px 0 0;white-space:pre-wrap;line-height:1.65}

    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{
      font-size:12px;color:rgba(238,242,255,.85);
      padding:5px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }

    .badge{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(238,242,255,.9);
      font-weight:800;
    }
    .badge.cat-algemeen{ border-color: rgba(139,92,246,.40); box-shadow:0 0 0 2px rgba(139,92,246,.10); }
    .badge.cat-filosofie{ border-color: rgba(34,211,238,.40); box-shadow:0 0 0 2px rgba(34,211,238,.10); }
    .badge.cat-persoonlijk{ border-color: rgba(52,211,153,.35); box-shadow:0 0 0 2px rgba(52,211,153,.10); }
    .badge.cat-poezie{ border-color: rgba(251,113,133,.35); box-shadow:0 0 0 2px rgba(251,113,133,.10); }

    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .mini{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px;align-items:center}
    .row-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}

    /* Like animatie */
    .btn.liked{
      animation: pop .45s ease;
      box-shadow: 0 0 0 2px rgba(251,113,133,.12);
      border-color: rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
    }
    @keyframes pop{
      0%{transform:scale(1)}
      40%{transform:scale(1.06)}
      100%{transform:scale(1)}
    }

    /* Comments box */
    .comments{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.18);
      display:none;
    }
    .comments.open{display:block}
    .c-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .c-item{display:flex;gap:10px;align-items:flex-start}
    .c-text{font-size:13px;line-height:1.5;color:rgba(238,242,255,.90)}
    .c-meta{font-size:12px;color:rgba(238,242,255,.60)}
    .c-form{display:flex;gap:10px;margin-top:10px}
    .c-form .input{flex:1}

    /* mobiel: sidebar boven content */
    @media (max-width: 860px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position: relative; top: 0; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand-wrap">
        <!-- Panda logo -->
<a class="logo" href="./index.html" title="Verhalen">
  <svg class="yy" viewBox="0 0 100 100" width="40" height="40" aria-hidden="true">
    <circle cx="50" cy="50" r="48" fill="white"/>
    <path d="M50 2 a48 48 0 1 0 0 96
             a24 24 0 1 1 0-48
             a24 24 0 1 0 0-48" fill="black"/>
    <circle cx="50" cy="26" r="6" fill="white"/>
    <circle cx="50" cy="74" r="6" fill="black"/>
  </svg>
</a>
        <div class="brand">
          <h1>Verhalen</h1>
          <p>Lees, deel, like en reageer ‚Äî met respect.</p>
        </div>
      </div>

      <div class="actions">
        <a class="btn" id="authBtn" href="./login.html">Inloggen</a>
        <a class="btn btn-primary" href="./deel.html">Deel jouw verhaal</a>
      </div>
    </div>

   <div id="status" class="status"></div>
    <div id="error" class="error"></div>
    <div id="ok" class="ok"></div>

    <div class="layout">
  <aside class="sidebar">

  <!-- üêº Panda mascotte -->
  <div class="panda-side">
    <img src="./panda.png" alt="Panda">
  </div>

  <div class="sb-title">Ontdekken</div>

<input id="q" class="input" placeholder="Zoek verhalen..." />

<div class="sb-group" id="catGroup">
  <div class="sb-chip active" data-cat="Alle">Alle</div>
  <div class="sb-chip" data-cat="Algemeen">Algemeen</div>
  <div class="sb-chip" data-cat="Filosofie">Filosofie</div>
  <div class="sb-chip" data-cat="Persoonlijk">Persoonlijk</div>
  <div class="sb-chip" data-cat="Po√´zie">Po√´zie</div>
</div>

 <div class="sb-group" id="sortGroup">
  <div class="sb-small">Sorteren</div>
  <div class="sb-chip" data-sort="top">‚ù§Ô∏è Meest geliket</div>
  <div class="sb-chip active" data-sort="new">üïí Nieuwste</div>
</div>

</aside>

      <div id="stories" class="grid"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    // ===== Globals =====
    const statusEl = document.getElementById("status");
    const errorEl  = document.getElementById("error");
    const okEl     = document.getElementById("ok");
    const wrapEl   = document.getElementById("stories");

    const qEl = document.getElementById("q");
    const catGroup = document.getElementById("catGroup");
    const sortGroup = document.getElementById("sortGroup");

    let CURRENT_USER = null;
    let ALL_STORIES = [];
    let activeCategory = "Alle";
    let activeSort = "new";
    let activeQuery = "";

    function setOk(msg){
      okEl.textContent = msg || "";
      if (msg) setTimeout(() => okEl.textContent = "", 1600);
    }
    function setErr(msg){
      errorEl.textContent = msg || "";
    }

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function formatDate(iso){
      try{
        return new Date(iso).toLocaleString("nl-NL", { dateStyle:"medium", timeStyle:"short" });
      }catch(e){ return ""; }
    }

    function catClass(cat){
      const c = (cat || "Algemeen").toLowerCase();
      if (c.includes("filo")) return "cat-filosofie";
      if (c.includes("pers")) return "cat-persoonlijk";
      if (c.includes("po"))   return "cat-poezie";
      return "cat-algemeen";
    }

    async function refreshUser(){
      if (!window.supabaseClient) return null;
      const { data: { user } } = await window.supabaseClient.auth.getUser();
      CURRENT_USER = user || null;
      return CURRENT_USER;
    }

    async function updateAuthButton(){
      const authBtn = document.getElementById("authBtn");
      if (!authBtn) return;

      if (!window.supabaseClient){
        authBtn.textContent = "Inloggen";
        authBtn.href = "./login.html";
        return;
      }

      // gebruik CURRENT_USER als die al gezet is, anders ophalen
      const user = CURRENT_USER || (await refreshUser());

      if (user){
        authBtn.textContent = "Profiel";
        authBtn.href = "./profile.html";
      }else{
        authBtn.textContent = "Inloggen";
        authBtn.href = "./login.html";
      }
    }

    // ===== Data helpers =====
    async function count(table, storyId){
      const { count, error } = await window.supabaseClient
        .from(table)
        .select("*", { count:"exact", head:true })
        .eq("story_id", storyId);
      if (error) return 0;
      return count ?? 0;
    }

    async function didILike(storyId){
      if (!CURRENT_USER) return false;
      const { data, error } = await window.supabaseClient
        .from("likes")
        .select("id")
        .eq("story_id", storyId)
        .eq("user_id", CURRENT_USER.id)
        .limit(1);

      if (error) return false;
      return Array.isArray(data) && data.length > 0;
    }

    async function toggleLike(storyId, btn){
      setErr(""); okEl.textContent = "";

      // animatie direct (ook als hij daarna faalt)
      btn.classList.remove("liked"); void btn.offsetWidth; btn.classList.add("liked");
      setTimeout(() => btn.classList.remove("liked"), 450);

      if (!CURRENT_USER){
        setErr("‚ùå Log in om te liken.");
        return;
      }

      btn.disabled = true;
      try{
        const liked = await didILike(storyId);
        if (liked){
          const { error } = await window.supabaseClient
            .from("likes")
            .delete()
            .eq("story_id", storyId)
            .eq("user_id", CURRENT_USER.id);
          if (error) throw error;
        }else{
          const { error } = await window.supabaseClient
            .from("likes")
            .insert({ story_id: storyId, user_id: CURRENT_USER.id });
          if (error) throw error;
        }

        await refreshMini(storyId);
      }catch(err){
        setErr("‚ùå " + (err?.message || String(err)));
      }finally{
        btn.disabled = false;
      }
    }

    async function loadComments(storyId){
      const box = document.getElementById("comments-"+storyId);
      const list = document.getElementById("c-list-"+storyId);
      if (!box || !list) return;

      list.innerHTML = `<div class="c-meta">Laden‚Ä¶</div>`;

      const { data, error } = await window.supabaseClient
        .from("comments")
        .select("id,user_id,author_name,content,created_at")
        .eq("story_id", storyId)
        .order("created_at", { ascending:true });

      if (error){
        list.innerHTML = `<div class="c-meta">‚ùå ${escapeHtml(error.message)}</div>`;
        return;
      }

      if (!data || data.length === 0){
        list.innerHTML = `<div class="c-meta">Nog geen reacties. Wees de eerste üôÇ</div>`;
        return;
      }

      list.innerHTML = "";
      for (const c of data){
        const av = escapeHtml((c.author_name || "A")[0].toUpperCase());
        const who = escapeHtml(c.author_name || "Anoniem");
        const when = formatDate(c.created_at);
        const txt = escapeHtml(c.content || "");

        const row = document.createElement("div");
        row.className = "c-item";
        row.innerHTML = `
          <div class="avatar" style="width:28px;height:28px;font-size:12px">${av}</div>
          <div>
            <div class="c-meta"><b>${who}</b> ‚Ä¢ ${when}</div>
            <div class="c-text">${txt}</div>
          </div>
        `;
        list.appendChild(row);
      }
    }

    async function addComment(storyId){
      setErr(""); okEl.textContent = "";

      if (!CURRENT_USER){
        setErr("‚ùå Log in om te reageren.");
        return;
      }

      const input = document.getElementById("c-input-"+storyId);
      if (!input) return;

      const text = (input.value || "").trim();
      if (!text){
        setErr("‚ùå Je reactie is leeg.");
        return;
      }

      input.disabled = true;

      try{
        // naam: eerst user_metadata.full_name als die bestaat, anders email prefix
        const name =
          (CURRENT_USER.user_metadata && (CURRENT_USER.user_metadata.full_name || CURRENT_USER.user_metadata.name)) ||
          (CURRENT_USER.email ? CURRENT_USER.email.split("@")[0] : "Gebruiker");

        const { error } = await window.supabaseClient
          .from("comments")
          .insert({
            story_id: storyId,
            user_id: CURRENT_USER.id,
            author_name: name,
            content: text
          });

        if (error) throw error;

        input.value = "";
        setOk("‚úÖ Reactie geplaatst!");
        await loadComments(storyId);
        await refreshMini(storyId);

      }catch(err){
        setErr("‚ùå " + (err?.message || String(err)));
      }finally{
        input.disabled = false;
      }
    }

    async function deleteStory(storyId){
      setErr(""); okEl.textContent = "";

      if (!CURRENT_USER){
        setErr("‚ùå Log in om te verwijderen.");
        return;
      }

      if (!confirm("Weet je zeker dat je dit verhaal wilt verwijderen?")) return;

      try{
        const { error } = await window.supabaseClient
          .from("stories")
          .delete()
          .eq("id", storyId)
          .eq("user_id", CURRENT_USER.id);

        if (error) throw error;

        setOk("‚úÖ Verhaal verwijderd.");
        await loadStories(); // reload alles
      }catch(err){
        setErr("‚ùå " + (err?.message || String(err)) + "\nTip: als je een fout krijgt, moeten likes/comments misschien cascade in de database.");
      }
    }

    async function refreshMini(storyId){
      const mini = document.getElementById("mini-"+storyId);
      if (!mini) return;

      const likes = await count("likes", storyId);
      const comments = await count("comments", storyId);

      const likeHint = CURRENT_USER ? "" : " (log in om te liken)";
      mini.innerHTML = `
        <span>‚ù§Ô∏è Likes: ${likes}</span>
        <span>üí¨ Reacties: ${comments}${likeHint}</span>
      `;
    }

    // ===== Rendering + Filters =====
    function applyFilters(){
      const q = (activeQuery || "").toLowerCase();

      let list = [...ALL_STORIES];

      if (activeCategory && activeCategory !== "Alle"){
        list = list.filter(s => (s.category || "Algemeen") === activeCategory);
      }

      if (q){
        list = list.filter(s => {
          const t = (s.title || "").toLowerCase();
          const c = (s.content || "").toLowerCase();
          const a = (s.author_name || "").toLowerCase();
          const tags = Array.isArray(s.tags) ? s.tags.join(" ").toLowerCase() : "";
          return t.includes(q) || c.includes(q) || a.includes(q) || tags.includes(q);
        });
      }

      if (activeSort === "top"){
        // sorteer op like_count (meegegeven bij loadStories)
        list.sort((a,b) => (b.like_count||0) - (a.like_count||0));
      }else{
        // newest
        list.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      }

      renderStories(list);
    }

    function renderStories(data){
      wrapEl.innerHTML = "";

      if (!data || data.length === 0){
        statusEl.textContent = "Geen resultaten.";
        return;
      }
      statusEl.textContent = "";

      for (const s of data){
        const canDelete = !!(CURRENT_USER && s.user_id && s.user_id === CURRENT_USER.id);

        const tags = Array.isArray(s.tags) ? s.tags : [];
        const tagsHtml = tags.length
          ? `<div class="tags">${tags.map(t => `<span class="tag">#${escapeHtml(t)}</span>`).join("")}</div>`
          : "";

        const av = escapeHtml((s.author_name || "A")[0].toUpperCase());
        const cat = escapeHtml(s.category || "Algemeen");

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="meta2">
            <div class="avatar">${av}</div>
            <div style="min-width:0">
              <div style="font-weight:900">${escapeHtml(s.author_name || "Anoniem")}</div>
              <div class="meta" style="margin:2px 0 0">
                <span>${formatDate(s.created_at)}</span>
                <span class="badge ${catClass(s.category)}">Categorie: ${cat}</span>
              </div>
            </div>
          </div>

          <h2 class="title">${escapeHtml(s.title || "Zonder titel")}</h2>
          <div class="content">${escapeHtml(s.content || "")}</div>
          ${tagsHtml}

          <div class="divider"></div>

          <div class="mini" id="mini-${s.id}">
            <span>‚ù§Ô∏è Likes: ${s.like_count ?? "‚Ä¶"}</span>
            <span>üí¨ Reacties: ${s.comment_count ?? "‚Ä¶"}</span>
            ${CURRENT_USER ? "" : `<span style="opacity:.75">(log in om te liken/reageren)</span>`}
          </div>

          <div class="row-actions">
            <button class="btn" data-action="like" data-id="${s.id}">‚ù§Ô∏è Like</button>
            <button class="btn" data-action="toggle-comments" data-id="${s.id}">üí¨ Reacties</button>
            ${canDelete ? `<button class="btn btn-danger" data-action="delete" data-id="${s.id}">üóëÔ∏è Verwijderen</button>` : ``}
          </div>

          <div class="comments" id="comments-${s.id}">
            <div class="c-meta">Reacties</div>
            <div class="c-list" id="c-list-${s.id}"></div>

            <div class="c-form">
              <input class="input" id="c-input-${s.id}" placeholder="Schrijf een reactie‚Ä¶" />
              <button class="btn btn-primary" data-action="send-comment" data-id="${s.id}">Plaatsen</button>
            </div>
          </div>
        `;

        wrapEl.appendChild(card);
      }
    }

   async function loadStories(){
  setErr(""); okEl.textContent = "";
  statusEl.textContent = "Verhalen laden‚Ä¶";
  wrapEl.innerHTML = "";

  try{
    if (!window.supabaseClient){
      throw new Error("Supabase client niet geladen. Check supabase.js.");
    }

    const { data: stories, error } = await window.supabaseClient
      .from("stories")
      .select("id,user_id,title,content,author_name,created_at,category,tags")
      .order("created_at", { ascending:false })
      .limit(100);

    if (error) throw error;

    if (!stories || stories.length === 0){
      statusEl.textContent = "Nog geen verhalen. Klik op ‚ÄòDeel jouw verhaal‚Äô om de eerste te plaatsen.";
      ALL_STORIES = [];
      return;
    }

    const ids = stories.map(s => s.id);

    // ‚úÖ Likes: als RLS het blokkeert -> niet crashen, gewoon 0 likes tonen
    let likesData = [];
    const likesRes = await window.supabaseClient
      .from("likes")
      .select("story_id")
      .in("story_id", ids);

    if (!likesRes.error && Array.isArray(likesRes.data)) {
      likesData = likesRes.data;
    }

    const likeMap = new Map();
    for (const r of likesData){
      likeMap.set(r.story_id, (likeMap.get(r.story_id) || 0) + 1);
    }

    // ‚úÖ Comments: idem
    let comData = [];
    const comRes = await window.supabaseClient
      .from("comments")
      .select("story_id")
      .in("story_id", ids);

    if (!comRes.error && Array.isArray(comRes.data)) {
      comData = comRes.data;
    }

    const comMap = new Map();
    for (const r of comData){
      comMap.set(r.story_id, (comMap.get(r.story_id) || 0) + 1);
    }

    ALL_STORIES = stories.map(s => ({
      ...s,
      like_count: likeMap.get(s.id) || 0,
      comment_count: comMap.get(s.id) || 0
    }));

    statusEl.textContent = "";
    applyFilters();

  }catch(err){
    statusEl.textContent = "";
    setErr("‚ùå " + (err?.message || String(err)));
  }
}

    // ===== Sidebar interactions =====
    qEl.addEventListener("input", () => {
      activeQuery = qEl.value || "";
      applyFilters();
    });

    catGroup.addEventListener("click", (e) => {
      const chip = e.target.closest(".sb-chip");
      if (!chip) return;
      document.querySelectorAll("#catGroup .sb-chip").forEach(x => x.classList.remove("active"));
      chip.classList.add("active");
      activeCategory = chip.dataset.cat || "Alle";
      applyFilters();
    });

    sortGroup.addEventListener("click", (e) => {
      const chip = e.target.closest(".sb-chip");
      if (!chip) return;
      document.querySelectorAll("#sortGroup .sb-chip").forEach(x => x.classList.remove("active"));
      chip.classList.add("active");
      activeSort = chip.dataset.sort || "new";
      applyFilters();
    });

    // ===== Buttons (Like / Reacties / Delete) =====
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const action = btn.dataset.action;
      const storyId = btn.dataset.id;

      if (!storyId) return;

      if (action === "like") {
        return toggleLike(storyId, btn);
      }

      if (action === "toggle-comments") {
        const box = document.getElementById("comments-"+storyId);
        if (!box) return;
        box.classList.toggle("open");
        if (box.classList.contains("open")){
          await loadComments(storyId);
        }
        return;
      }

      if (action === "send-comment") {
        return addComment(storyId);
      }

      if (action === "delete") {
        return deleteStory(storyId);
      }
    });

    // ===== Init / auth / back-cache =====
    (async () => {
      await refreshUser();
      await updateAuthButton();
      await loadStories();

      if (window.supabaseClient){
        window.supabaseClient.auth.onAuthStateChange(async () => {
          await refreshUser();
          await updateAuthButton();
          await loadStories();
        });
      }
    })();

    window.addEventListener("pageshow", async () => {
      // als je via "terug" komt, zorg dat alles opnieuw klopt
      await refreshUser();
      await updateAuthButton();
      await loadStories();
    });
  </script>
</body>
</html>
