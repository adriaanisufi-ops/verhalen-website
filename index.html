<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verhalen</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020;
      --bg2:#0f1732;
      --card: rgba(255,255,255,.06);
      --text:#eef2ff;
      --muted: rgba(238,242,255,.70);
      --border: rgba(255,255,255,.12);
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --danger:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(139,92,246,.30), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(34,211,238,.22), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .container{
      max-width: 980px;
      margin: 26px auto;
      padding: 0 14px 60px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding: 14px 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand-wrap{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logo{
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(circle at 30% 30%, rgba(139,92,246,.35), rgba(34,211,238,.15));
      box-shadow:
        0 0 20px rgba(139,92,246,.35),
        0 0 40px rgba(34,211,238,.15);
      flex: 0 0 auto;
    }

    .logo svg{
      border-radius:50%;
      animation: spin 18s linear infinite;
    }

    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    @media (prefers-reduced-motion: reduce){
      .logo svg{ animation: none; }
      .story{ animation: none !important; opacity: 1 !important; transform:none !important; }
      .btn, .like{ transition:none !important; }
    }

    .brand{
      display:flex; flex-direction:column; gap:4px;
      min-width: 0;
    }
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font: inherit;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); opacity:.92; }

    .btn-primary{
      border-color: rgba(139,92,246,.35);
      background: linear-gradient(135deg, rgba(139,92,246,.85), rgba(34,211,238,.70));
      box-shadow: 0 10px 24px rgba(139,92,246,.18);
    }
    .btn-primary:hover{ background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.80)); }

    .status{
      margin: 14px 4px 0;
      color: var(--muted);
      font-size: 14px;
    }
    .error{
      margin: 10px 4px 0;
      color: var(--danger);
      white-space: pre-wrap;
      font-size: 14px;
    }

    /* Cards */
    .story{
      margin-top: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.05));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(10px);
      opacity: 0;
      animation: fadeUp .35s ease forwards;
    }
    @keyframes fadeUp{ to{ transform: translateY(0); opacity:1; } }

    .story-head{ padding: 16px 16px 8px; }
    .story h2{
      margin:0;
      font-size: 17px;
      letter-spacing: -0.02em;
      line-height: 1.25;
    }

    .meta{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
    }
    .tag{
      border-color: rgba(34,211,238,.28);
      background: rgba(34,211,238,.10);
      color: rgba(238,242,255,.85);
    }
    .cat{
      border-color: rgba(139,92,246,.28);
      background: rgba(139,92,246,.12);
      color: rgba(238,242,255,.90);
    }

    .story-body{
      padding: 0 16px 14px;
      line-height: 1.75;
      white-space: pre-wrap;
      color: rgba(238,242,255,.92);
    }

    .story-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .left-actions{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .small{ font-size: 13px; color: var(--muted); }

    /* Like button */
    .like{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }
    .like:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .like:active{ transform: translateY(0px); opacity:.92; }
    .like.active{
      border-color: rgba(251,113,133,.40);
      background: rgba(251,113,133,.16);
    }

    /* Comments */
    .comments{
      display:none;
      padding: 12px 16px 16px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .comments.open{ display:block; }

    .comment{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
      background: rgba(255,255,255,.06);
    }
    .comment p{
      margin: 8px 0 0;
      white-space: pre-wrap;
      line-height: 1.55;
      color: rgba(238,242,255,.92);
    }

    .form{ margin-top: 12px; display:grid; gap:10px; }
    input, textarea{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font: inherit;
      outline: none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(238,242,255,.55); }
    textarea{ min-height: 110px; resize: vertical; }
    .row{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap: wrap; }
    .hint{ color: var(--muted); font-size: 13px; }

    /* Mobile polish */
    @media (max-width: 520px){
      .container{ margin: 18px auto; }
      .btn{ width: 100%; }
      .topbar{ flex-direction: column; align-items: stretch; }
      .story-head, .story-body, .story-actions, .comments{ padding-left: 12px; padding-right: 12px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand-wrap">
        <div class="logo" title="Yin & Yang">
          <svg viewBox="0 0 100 100" width="36" height="36" aria-hidden="true">
            <circle cx="50" cy="50" r="48" fill="white"/>
            <path d="M50 2
                     a48 48 0 1 0 0 96
                     a24 24 0 1 1 0-48
                     a24 24 0 1 0 0-48" fill="black"/>
            <circle cx="50" cy="26" r="6" fill="white"/>
            <circle cx="50" cy="74" r="6" fill="black"/>
          </svg>
        </div>

        <div class="brand">
          <h1>Verhalen</h1>
          <p>Lees, deel, like en reageer ‚Äî met respect.</p>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end">   <a class="btn" id="authBtn" href="login.html">Inloggen</a>   <a class="btn btn-primary" href="deel.html">Deel jouw verhaal</a> </div>
    </div>

    <div id="status" class="status">Verhalen laden...</div>
    <div id="error" class="error"></div>
    <div id="stories"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>

  <script>
    // ---------- helpers ----------
    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function fmtDate(ts){
      try { return new Date(ts).toLocaleString("nl-NL"); }
      catch { return ""; }
    }
    function ensureVisitorId(){
      let id = localStorage.getItem("visitor_id");
      if (!id) {
        id = (crypto?.randomUUID?.() || ("v_" + Math.random().toString(16).slice(2) + Date.now()));
        localStorage.setItem("visitor_id", id);
      }
      return id;
    }
    const VISITOR_ID = ensureVisitorId();

    function normalizeTags(tags){
      if (!tags) return [];
      if (Array.isArray(tags)) return tags.filter(Boolean).map(t => String(t).trim()).filter(Boolean);
      return String(tags).split(",").map(t => t.trim()).filter(Boolean);
    }

    // ---------- main ----------
    async function loadStories() {
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const wrap = document.getElementById("stories");

      errorEl.textContent = "";
      wrap.innerHTML = "";
      statusEl.textContent = "Verhalen laden...";

      try {
        if (!window.supabaseClient) throw new Error("Supabase client niet geladen. Controleer supabase.js.");

        // 1) stories
        const { data: stories, error: sErr } = await window.supabaseClient
          .from("stories")
          .select("id,title,author_name,created_at,content,category,tags")
          .order("created_at", { ascending: false })
          .limit(50);

        if (sErr) throw sErr;

        if (!stories || stories.length === 0) {
          statusEl.textContent = "Nog geen verhalen. Wees de eerste!";
          return;
        }

        statusEl.textContent = "";

        // 2) likes for these stories
        const storyIds = stories.map(s => s.id);

        const { data: allLikes, error: lErr } = await window.supabaseClient
          .from("likes")
          .select("story_id,visitor_id")
          .in("story_id", storyIds);

        if (lErr) throw lErr;

        const likeCounts = new Map();
        const likedByMe = new Set();

        (allLikes || []).forEach(l => {
          likeCounts.set(l.story_id, (likeCounts.get(l.story_id) || 0) + 1);
          if (l.visitor_id === VISITOR_ID) likedByMe.add(l.story_id);
        });

        // 3) render
        stories.forEach((s, i) => {
          const tags = normalizeTags(s.tags);
          const category = (s.category || "Algemeen").trim();
          const likes = likeCounts.get(s.id) || 0;
          const isLiked = likedByMe.has(s.id);

          const el = document.createElement("section");
          el.className = "story";
          el.style.animationDelay = (i * 28) + "ms";

          el.innerHTML = `
            <div class="story-head">
              <h2>${escapeHtml(s.title)}</h2>
              <div class="meta">
                <span class="pill">üóìÔ∏è ${fmtDate(s.created_at)}</span>
                ${s.author_name ? `<span class="pill">üë§ ${escapeHtml(s.author_name)}</span>` : `<span class="pill">üë§ Anoniem</span>`}
                <span class="pill cat">üè∑Ô∏è ${escapeHtml(category)}</span>
                ${tags.slice(0, 10).map(t => `<span class="pill tag">#${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>

            <div class="story-body">${escapeHtml(s.content)}</div>

            <div class="story-actions">
              <div class="left-actions">
                <button class="like ${isLiked ? "active" : ""}" data-action="toggle-like" data-story="${s.id}">
                  <span>‚ù§Ô∏è</span>
                  <span id="like-count-${s.id}">${likes}</span>
                </button>

                <button class="btn" data-action="toggle-comments" data-story="${s.id}">
                  üí¨ Reacties
                </button>

                <span class="small" id="comment-count-${s.id}"></span>
              </div>
              <span class="small"></span>
            </div>

            <div class="comments" id="comments-${s.id}">
              <div class="hint" id="cstatus-${s.id}">Reacties laden...</div>
              <div id="clist-${s.id}"></div>

              <form class="form" data-action="comment-form" data-story="${s.id}">
                <input name="author" placeholder="Jouw naam (optioneel)" />
                <textarea name="content" placeholder="Schrijf een reactie..." required></textarea>
                <div class="row">
                  <span class="hint" id="cmsg-${s.id}"></span>
                  <button class="btn btn-primary" type="submit">Plaats reactie</button>
                </div>
              </form>
            </div>
          `;

          wrap.appendChild(el);
        });

        // events (delegation)
        wrap.addEventListener("click", async (e) => {
          const likeBtn = e.target.closest("[data-action='toggle-like']");
          if (likeBtn) {
            const storyId = likeBtn.getAttribute("data-story");
            await toggleLike(storyId, likeBtn);
            return;
          }

          const cBtn = e.target.closest("[data-action='toggle-comments']");
          if (cBtn) {
            const storyId = cBtn.getAttribute("data-story");
            const panel = document.getElementById(`comments-${storyId}`);
            const isOpen = panel.classList.toggle("open");
            cBtn.textContent = isOpen ? "üôà Verbergen" : "üí¨ Reacties";
            if (isOpen) await loadComments(storyId);
            return;
          }
        });

        wrap.addEventListener("submit", async (e) => {
          const form = e.target.closest("[data-action='comment-form']");
          if (!form) return;
          e.preventDefault();
          const storyId = form.getAttribute("data-story");
          await submitComment(form, storyId);
        });

        // preload comment counts
        storyIds.forEach(id => loadCommentCount(id));

      } catch (err) {
        console.error(err);
        statusEl.textContent = "";
        errorEl.textContent = "Fout:\n" + (err?.message || String(err));
      }
    }

    // ---------- likes ----------
    async function toggleLike(storyId, btnEl) {
      const countEl = document.getElementById(`like-count-${storyId}`);
      const wasLiked = btnEl.classList.contains("active");

      // Optimistic UI
      btnEl.classList.toggle("active");
      const current = parseInt(countEl.textContent || "0", 10);
      countEl.textContent = String(Math.max(0, current + (wasLiked ? -1 : 1)));

      try {
        if (wasLiked) {
          const { error } = await window.supabaseClient
            .from("likes")
            .delete()
            .eq("story_id", storyId)
            .eq("visitor_id", VISITOR_ID);
          if (error) throw error;
        } else {
          const { error } = await window.supabaseClient
            .from("likes")
            .insert({ story_id: storyId, visitor_id: VISITOR_ID });
          if (error) throw error;
        }
      } catch (err) {
        console.error(err);
        // Revert UI
        btnEl.classList.toggle("active");
        countEl.textContent = String(current);
        alert("Like lukt niet: " + (err?.message || String(err)));
      }
    }

    // ---------- comments ----------
    async function loadCommentCount(storyId){
      try{
        const { count, error } = await window.supabaseClient
          .from("comments")
          .select("id", { count: "exact", head: true })
          .eq("story_id", storyId);

        if (error) throw error;

        const el = document.getElementById(`comment-count-${storyId}`);
        if (el) el.textContent = `${count ?? 0} reactie(s)`;
      } catch {}
    }

    async function loadComments(storyId){
      const statusEl = document.getElementById(`cstatus-${storyId}`);
      const listEl = document.getElementById(`clist-${storyId}`);

      statusEl.textContent = "Reacties laden...";
      listEl.innerHTML = "";

      try{
        const { data, error } = await window.supabaseClient
          .from("comments")
          .select("id,author_name,content,created_at")
          .eq("story_id", storyId)
          .order("created_at", { ascending: true });

        if (error) throw error;

        if (!data || data.length === 0){
          statusEl.textContent = "Nog geen reacties. Wees de eerste!";
          return;
        }

        statusEl.textContent = "";
        data.forEach(c => {
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `
            <div class="meta">
              <span class="pill">üóìÔ∏è ${fmtDate(c.created_at)}</span>
              ${c.author_name ? `<span class="pill">üë§ ${escapeHtml(c.author_name)}</span>` : `<span class="pill">üë§ Anoniem</span>`}
            </div>
            <p>${escapeHtml(c.content)}</p>
          `;
          listEl.appendChild(div);
        });

      } catch(err){
        console.error(err);
        statusEl.textContent = "Fout bij laden reacties: " + (err?.message || String(err));
      }
    }

    async function submitComment(form, storyId){
      const msgEl = document.getElementById(`cmsg-${storyId}`);
      msgEl.textContent = "Plaatsen...";

      const author = (form.elements.author.value || "").trim();
      const content = (form.elements.content.value || "").trim();

      try{
        const { error } = await window.supabaseClient
          .from("comments")
          .insert({
            story_id: storyId,
            author_name: author || null,
            content
          });

        if (error) throw error;

        form.reset();
        msgEl.textContent = "‚úÖ Geplaatst!";
        setTimeout(() => (msgEl.textContent = ""), 1200);

        await loadComments(storyId);
        await loadCommentCount(storyId);

      } catch(err){
        console.error(err);
        msgEl.textContent = "‚ùå " + (err?.message || String(err));
      }
    }
  async function updateAuthButton(){
    const authBtn = document.getElementById("authBtn");
    if (!authBtn || !window.supabaseClient) return;

    const { data: { user } } = await window.supabaseClient.auth.getUser();

    if (user) {
      authBtn.textContent = "Profiel";
      authBtn.href = "profile.html";
    } else {
      authBtn.textContent = "Inloggen";
      authBtn.href = "login.html";
    }
  }

window.addEventListener("pageshow", (e) => {
  if (e.persisted) {
    location.reload(); // komt uit back-cache ‚Üí echte reload
    return;
  }
  updateAuthButton();
  loadStories();
});
});
  </script>

</body>
</html>
